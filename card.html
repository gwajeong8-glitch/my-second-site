<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Noblesse — 카드 에디터</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>카드 편집기</h1>

  <div class="container">
    <div class="preview">
      <canvas id="cardCanvas" aria-label="카드 미리보기"></canvas>
      <div class="note">실시간 미리보기 — 저장 후 다운로드하세요.</div>
    </div>

    <div class="panel">
      <div id="context" style="font-weight:800; margin-bottom:8px;">메뉴 - VIP</div>

      <label>이름 (ID)</label>
      <input id="inputID" type="text" value="ID: 홍길동">

      <label>Card No</label>
      <input id="inputCard" type="text" value="CARD NO: 0000000000">

      <label>이름 폰트 크기(px)</label>
      <input id="sizeName" type="number" value="40" min="8" max="140">

      <label>번호 폰트 크기(px)</label>
      <input id="sizeNo" type="number" value="28" min="8" max="100">

      <label>텍스트 색상</label>
      <input id="colorText" type="color" value="#F6EAD2">

      <hr>

      <label>ID X</label>
      <input id="idX" type="number" value="380">

      <label>ID Y</label>
      <input id="idY" type="number" value="660">

      <label>NO X</label>
      <input id="noX" type="number" value="380">

      <label>NO Y</label>
      <input id="noY" type="number" value="710">

      <div class="row">
        <button class="btn save" id="btnSave">메뉴별 저장</button>
        <button class="btn download" id="btnDownload">PNG 다운로드</button>
      </div>
    </div>
  </div>

<script>
function qp(name){
  return new URL(location.href).searchParams.get(name);
}
const menuNum = qp('menu') || '1';
const vipNum = qp('vip') || '1';
document.getElementById('context').innerText = `메뉴 ${menuNum} · VIP ${vipNum}`;

const canvas = document.getElementById('cardCanvas');
const ctx = canvas.getContext('2d');

const inputID = document.getElementById('inputID');
const inputCard = document.getElementById('inputCard');
const sizeName = document.getElementById('sizeName');
const sizeNo = document.getElementById('sizeNo');
const colorText = document.getElementById('colorText');

const idX = document.getElementById('idX');
const idY = document.getElementById('idY');
const noX = document.getElementById('noX');
const noY = document.getElementById('noY');

const btnSave = document.getElementById('btnSave');
const btnDownload = document.getElementById('btnDownload');

const imgSrc = `img/vip${vipNum}.png`;
const baseImg = new Image();
baseImg.src = imgSrc;
baseImg.crossOrigin = "anonymous";

canvas.width = 1024;
canvas.height = 1024;

const storageKey = (menu, vip) => `noblesse_menu${menu}_vip${vip}`;

(function loadSaved(){
  const raw = localStorage.getItem(storageKey(menuNum, vipNum));
  if (!raw) return;

  try {
    const o = JSON.parse(raw);
    inputID.value = o.id || inputID.value;
    inputCard.value = o.card || inputCard.value;
    sizeName.value = o.sizeName || sizeName.value;
    sizeNo.value = o.sizeNo || sizeNo.value;
    colorText.value = o.color || colorText.value;

    idX.value = o.idX || idX.value;
    idY.value = o.idY || idY.value;
    noX.value = o.noX || noX.value;
    noY.value = o.noY || noY.value;
  } catch(e){}
})();

function render(){
  if (baseImg.complete && baseImg.naturalWidth){
    canvas.width = baseImg.naturalWidth;
    canvas.height = baseImg.naturalHeight;
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (baseImg.complete){
    ctx.drawImage(baseImg, 0, 0, canvas.width, canvas.height);
  }

  const nameSize = parseInt(sizeName.value);
  const noSize = parseInt(sizeNo.value);
  const txtColor = colorText.value;

  ctx.shadowColor = "rgba(0,0,0,0.6)";
  ctx.shadowBlur = 6;

  ctx.fillStyle = txtColor;

  ctx.font = `${nameSize}px sans-serif`;
  ctx.fillText(inputID.value, parseInt(idX.value), parseInt(idY.value));

  ctx.font = `${noSize}px sans-serif`;
  ctx.fillText(inputCard.value, parseInt(noX.value), parseInt(noY.value));
}

[inputID, inputCard, sizeName, sizeNo, colorText, idX, idY, noX, noY]
  .forEach(el => el.addEventListener('input', render));

baseImg.onload = render;

btnSave.addEventListener('click', ()=>{
  const data = {
    id: inputID.value,
    card: inputCard.value,
    sizeName: sizeName.value,
    sizeNo: sizeNo.value,
    color: colorText.value,
    idX: idX.value,
    idY: idY.value,
    noX: noX.value,
    noY: noY.value
  };
  localStorage.setItem(storageKey(menuNum, vipNum), JSON.stringify(data));
  alert("저장되었습니다.");
});

btnDownload.addEventListener('click', ()=>{
  render();
  canvas.toBlob(blob=>{
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `menu${menuNum}_vip${vipNum}.png`;
    link.click();
  });
});

setTimeout(render, 300);
</script>
</body>
</html>
