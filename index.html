<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¸ë¸”ë ˆìŠ¤ ë°ì´í„° í˜„í™© (í†µí•©ë³¸)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* Base Styling */
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #1a1a1a;
            color: #ddd;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            user-select: none; /* ì¤‘ìš”: ë“œë˜ê·¸ ì„ íƒ ì‹œ ë¸Œë¼ìš°ì € ê¸°ë³¸ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
        }

        .wrap {
            flex-grow: 1;
            padding: 20px 20px 20px 200px;
            position: relative;
            max-width: calc(100vw - 320px);
            overflow: auto;
        }

        /* Setting Panel Styling */
        .setting-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background-color: #2c2c2c;
            padding: 15px;
            box-shadow: -3px 0 10px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            z-index: 100;
            user-select: auto; /* íŒ¨ë„ ë‚´ë¶€ëŠ” ì„ íƒ ê°€ëŠ¥í•˜ê²Œ */
        }

        .setting-panel h3 {
            font-size: 1.1em;
            color: #ffdd66;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .color-target-control label {
            margin-right: 15px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 5px 0;
            border: 1px solid #444;
            border-radius: 5px;
            background-color: #333;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border: 1px solid #555;
            cursor: pointer;
            border-radius: 3px;
            transition: transform 0.1s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
            border-color: #ffdd66;
        }

        .download-button {
            width: 100%;
            margin-top: 20px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .download-button:hover {
            background-color: #45a049;
        }

        .small-btn { padding:6px 8px; background:#444;color:#fff;border-radius:4px;border:none;cursor:pointer }
        .small-btn:hover{background:#555}
        .small-btn:disabled{background:#222; cursor:not-allowed; color:#888;}

        /* Menu Styling */
        .top-sub-menu {
            display: flex;
            margin-bottom: 12px;
            border-bottom: 2px solid #555;
            padding-bottom: 8px;
        }

        .menu {
            margin-right: 20px;
            font-size: 0.9em;
            color: #aaa;
            cursor: pointer;
            transition: color 0.2s;
        }

        .menu:hover {
            color: #fff;
        }
        .menu.active { color: #fff; font-weight: 600; border-bottom: 2px solid #ffdd66; padding-bottom: 6px; }

        /* Left menu */
        .left-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 180px;
            height: 100vh;
            background-color: #222;
            padding: 20px 0;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .left-item {
            padding: 10px 16px;
            font-size: 0.95em;
            color: #bbb;
            cursor: pointer;
            transition: background-color 0.12s, color 0.12s;
            border-left: 6px solid transparent;
            margin-bottom: 4px;
            border-radius: 0 6px 6px 0;
        }

        .left-item:hover {
            background: rgba(255,221,102,0.03);
            color: #fff;
        }

        .left-item.active {
            background: linear-gradient(90deg, rgba(255,221,102,0.06), rgba(255,221,102,0.02));
            border-left-color: #ffdd66;
            color: #fff;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        /* menu indicator */
        .menu-indicator {
            margin-bottom: 12px;
            padding: 8px 12px;
            background: rgba(255,221,102,0.06);
            color: #ffdd66;
            border-radius: 6px;
            font-weight: 600;
            display: inline-block;
        }

        /* Table Styling */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            table-layout: fixed;
            user-select: auto; /* í…Œì´ë¸” ë‚´ë¶€ëŠ” í…ìŠ¤íŠ¸ í¸ì§‘ì„ ìœ„í•´ ì„ íƒ ê°€ëŠ¥ */
        }

        .data-table td {
            border: 1px solid #444;
            padding: 5px 8px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            /* line-height: 1; -> app.jsì—ì„œ ë™ì ìœ¼ë¡œ ê´€ë¦¬ */
            height: 15px;
            box-sizing: border-box;
            transition: background-color 0.1s, border-color 0.1s;
        }

        /* Row Group Styles */
        .top-notice-row td {
            background-color: #581616;
            color: #ffe6e6;
            font-weight: bold;
            text-align: left;
            padding: 8px 12px;
            height: 25px;
        }
        .top-notice-mark {
            color: #ffdd66;
            margin-right: 8px;
        }

        .top-data-header td, .bottom-data-header td {
            background-color: #444;
            color: #fff;
            font-weight: bold;
            height: 30px;
            min-width: 80px;
        }

        .middle-notice-row td {
            background-color: #3a3a3a;
            color: #ffb3b3;
            text-align: left;
            font-size: 0.9em;
            line-height: 1.4;
            height: 50px;
        }

        .bottom-data-row td {
            background-color: #333;
            color: #ddd;
        }

        /* Editable Content Styling */
        .data-table td[contenteditable="true"] {
            outline: none;
        }
        .data-table td[contenteditable="false"] {
            cursor: not-allowed;
        }

        /* Selection Box (for drag visual) */
        #selectionBox {
            position: absolute;
            border: 2px dashed #FFD700;
            background-color: rgba(255, 215, 0, 0.2);
            pointer-events: none;
            z-index: 10;
            display: none;
        }

        /* Selected Cell Styling (Actual selection state) */
        .data-table td.selected {
            border: 2px solid #ffdd66 !important;
            box-shadow: inset 0 0 0 1px #ffdd66, 0 0 5px rgba(255, 221, 102, 0.5);
            position: relative;
            z-index: 5;
        }

        /* Resizer Styling (Placeholder) */
        .col-resizer { position: absolute; right: -4px; top: 0; width: 8px; height: 100%; cursor: col-resize; z-index: 20; }
        .row-resizer { position: absolute; bottom: -4px; right: 0; width: 100%; height: 8px; cursor: row-resize; z-index: 20; }
        .resizer-display { position: fixed; padding: 5px 10px; background: rgba(0, 0, 0, 0.8); color: #ffdd66; border-radius: 4px; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 101; font-size: 0.8em; white-space: nowrap; }

        /* small responsive fix */
        @media (max-width: 900px) {
            .wrap { padding-left: 20px; }
            .left-menu { display: none; }
        }
    </style>
</head>
<body>

<div class="setting-panel" id="settingPanel">
    <div style="color: #ffdd66; margin-top: 5px; margin-bottom: 10px; font-weight: bold;">
        â€» ì‚¬ìš©ë²•: í…Œì´ë¸” ì…€ì„ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒí•œ í›„, ì•„ë˜ ì˜µì…˜ì„ í´ë¦­í•˜ë©´ ì ìš©ë©ë‹ˆë‹¤.
    </div>

    <div class="color-target-control">
        <label><input type="radio" name="colorTarget" value="text" checked> ê¸€ììƒ‰ ì ìš©</label>
        <label><input type="radio" name="colorTarget" value="background"> ë°°ê²½ìƒ‰ ì ìš©</label>
    </div>

    <div class="color-control">
        <h3>ğŸ¨ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì„ íƒ (40ìƒ‰)</h3>
        <div class="color-palette" id="colorPaletteContainer"></div>
    </div>

    <div style="margin-top: 10px; padding-top: 15px; border-top: 1px solid #444;">
        <label for="fontSizeInput">ê¸€ê¼´ í¬ê¸° (px): </label>
        <input type="number" id="fontSizeInput" min="8" max="48" value="14" style="width: 60px; margin-left: 5px; padding: 5px; color: black; border-radius: 3px; border: none;">
        <button id="applyFontSizeBtn" style="margin-left: 5px; padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px; cursor: pointer; transition: background 0.2s;">ì ìš©</button>
    </div>

    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
        <h3>ğŸ“Š í…Œì´ë¸” êµ¬ì¡° ë° í¬ê¸° ì¡°ì ˆ</h3>
        <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
            <div>
                <label for="newRowCount">í–‰ ê°œìˆ˜:</label>
                <input type="number" id="newRowCount" min="1" value="12" style="width: 50px; padding: 5px; color: black; border-radius: 3px; border: none;">
            </div>
            <div>
                <label for="newColCount">ì—´ ê°œìˆ˜:</label>
                <input type="number" id="newColCount" min="1" value="5" style="width: 50px; padding: 5px; color: black; border-radius: 3px; border: none;">
            </div>
        </div>
        <div style="margin-bottom: 10px; display: flex; justify-content: space-between;">
            <div>
                <label for="defaultColWidth">ê¸°ë³¸ ë„ˆë¹„(px):</label>
                <input type="number" id="defaultColWidth" min="50" value="120" style="width: 50px; padding: 5px; color: black; border-radius: 3px; border: none;">
            </div>
            <div>
                <label for="defaultRowHeight">ê¸°ë³¸ ë†’ì´(px):</label>
                <input type="number" id="defaultRowHeight" min="20" value="25" style="width: 50px; padding: 5px; color: black; border-radius: 3px; border: none;">
            </div>
        </div>
        <button id="applyTableStructureBtn" class="download-button" style="background: #3498db; margin-top: 5px;">í…Œì´ë¸” êµ¬ì¡°/í¬ê¸° ì ìš©</button>
    </div>
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
        <h3>ğŸ“ ê·¸ë£¹ë³„ í–‰ ë†’ì´ (px)</h3>
        
        <div style="margin-bottom: 10px;">
            <label for="topRowHeightInput" style="display: block; margin-bottom: 5px;">ìƒë‹¨ ë°ì´í„° í–‰ ë†’ì´:</label>
            <input type="number" id="topRowHeightInput" min="10" max="200" value="25" style="width: 60px; padding: 5px; color: black; border-radius: 3px; border: none;">
            <button id="applyTopRowHeightBtn" class="height-apply-btn" data-target="top-data" style="margin-left: 5px; padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px; cursor: pointer;">ì ìš©</button>
        </div>

        <div style="margin-bottom: 10px;">
            <label for="middleNoticeRowHeightInput" style="display: block; margin-bottom: 5px;">ì¤‘ë‹¨ ê³µì§€/ì œëª© í–‰ ë†’ì´:</label>
            <input type="number" id="middleNoticeRowHeightInput" min="20" max="300" value="50" style="width: 60px; padding: 5px; color: black; border-radius: 3px; border: none;">
            <button id="applyMiddleNoticeRowHeightBtn" class="height-apply-btn" data-target="middle-notice" style="margin-left: 5px; padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px; cursor: pointer;">ì ìš©</button>
        </div>

        <div>
            <label for="bottomRowHeightInput" style="display: block; margin-bottom: 5px;">í•˜ë‹¨ ë°ì´í„° í–‰ ë†’ì´:</label>
            <input type="number" id="bottomRowHeightInput" min="10" max="200" value="25" style="width: 60px; padding: 5px; color: black; border-radius: 3px; border: none;">
            <button id="applyBottomRowHeightBtn" class="height-apply-btn" data-target="bottom-data" style="margin-left: 5px; padding: 5px 12px; background: #555; color: white; border: none; border-radius: 3px; cursor: pointer;">ì ìš©</button>
        </div>
        <button id="autoFitBtn" class="small-btn" style="margin-top: 10px; width: 100%; background: #007bff;">ì—´ ë„ˆë¹„ ìë™ ë§ì¶¤ (Auto-Fit)</button>
    </div>

    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
        <h3>âš™ï¸ ì‘ì—… ë„êµ¬</h3>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
            <button id="autoSaveToggleBtn" class="small-btn">ìë™ì €ì¥: OFF</button>
            <button id="saveNowBtn" class="small-btn">ì €ì¥</button>
            <button id="copyBtn" class="small-btn">ë³µì‚¬</button>
            <button id="pasteBtn" class="small-btn">ë¶™ì—¬ë„£ê¸°</button>
        </div>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
            <button id="addRowBtn" class="small-btn">í–‰ ì¶”ê°€</button>
            <button id="addColBtn" class="small-btn">ì—´ ì¶”ê°€</button>
            <button id="deleteRowBtn" class="small-btn">í–‰ ì‚­ì œ</button>
            <button id="deleteColBtn" class="small-btn">ì—´ ì‚­ì œ</button>
        </div>
        <div style="display:flex; gap:8px;">
            <button id="toggleAdminBtn" class="small-btn" style="background: #a33;">ê´€ë¦¬ì ëª¨ë“œ: OFF</button>
            <button id="downloadBtn" class="small-btn" style="background: #4CAF50;">ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
        </div>
    </div>

    <button class="download-button" id="downloadFullBtn" style="margin-top:12px;">ğŸ–¼ï¸ í…Œì´ë¸” ì˜ì—­ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (PNG)</button>
</div>

<div class="left-menu" id="leftMenu">
    <div class="left-item active">ë©”ì¸ í™”ë©´</div>
    <div class="left-item">[ë§¤ì¹­/ê³ ê° ìƒíƒœ]</div>
    <div class="left-item">ì£¼ë¬¸ ìƒíƒœ</div>
    <div class="left-item">ì¸ì¦ ìƒíƒœ</div>
    <div class="left-item">[ìƒë‹´/ë¬¸ì˜]</div>
    <div class="left-item">ì§ë¬´ ë¬¸ì˜</div>
    <div class="left-item">ì „êµ­ ë§Œë‚¨</div>
    <div class="left-item">[ê´€ë¦¬/ë°ì´í„°]</div>
    <div class="left-item">ì‹¤ì‹œê°„ ë°ì´í„°</div>
    <div class="left-item">ì‹¤ì‹œê°„ ì˜¤ë¥˜</div>
    <div class="left-item">ë°ì´í„° ë¶„ì„</div>
    <div class="left-item">í¬ì¸íŠ¸ ì¡°íšŒ</div>
    <div class="left-item">ìœ í¥ ê´€ë¦¬</div>
    <div class="left-item">íšŒì› ê´€ë¦¬</div>
    <div class="left-item">íšŒì› ìŠ¹ì¸</div>
    <div class="left-item">íšŒì› íƒˆí‡´</div>
    <div class="left-item">ë‹´ë‹¹ ì‹¤ì¥</div>
</div>

<div class="wrap">
    <div id="selectionBox"></div>

    <div class="top-sub-menu" id="topSubMenu">
        <div class="menu active">ë¸”ë ˆìŠ¤ ì „êµ­ í”„ë ˆìŠ¤í‹°ì§€ ì„œë¹„ìŠ¤</div>
        <div class="menu">VIP íšŒì› ì „ìš© í†µí•© ë§¤ë‹ˆì§€ë¨¼íŠ¸</div>
        <div class="menu">ë…¸ë¸”ë ˆìŠ¤ íšŒì› ì „ìš©ë£¸</div>
    </div>
    
    <div id="menuIndicator" class="menu-indicator">ì„ íƒ: ë©”ì¸ í™”ë©´</div>

    <table class="data-table" id="capture-area">
        <tbody>
            <tr class="top-notice-row">
                <td colspan="5" contenteditable="false">
                    <span class="top-notice-mark">DAMAGE!</span> ì£¼ì˜ì‚¬í•­ 4ë‹¨ê³„ì—ì„œ ì¼ì¹˜ íŒŒíŠ¸ë„ˆì‹­ìœ¼ë¡œ í†µí•©ëœ ìœ í˜•ë§Œì„ ì„ íƒí•˜ì—¬ ê³µìœ  ì„ë¬´ë¥¼ ì™„ë£Œí•˜ë©° í•¨ê»˜ í• ë•Œì˜ ê¸ˆì¼ ê²°ì œ ê¸ˆì•¡ í›„ ê³µë™ ì´ìµì„ ë§ˆê°í•´ì•¼ í•©ë‹ˆë‹¤!
                </td>
            </tr>
            
            <tr class="top-data-header">
                <td contenteditable="false">íšŒì›ID</td>
                <td contenteditable="false">ì£¼ë¬¸ìƒíƒœ</td>
                <td contenteditable="false">ì¸ì¦ìƒíƒœ</td>
                <td contenteditable="false">í™œì„±í™” ì½”ë“œ</td>
                <td contenteditable="false">ìŠ¹ì¸ëœ ì•”í˜¸ ì½”ë“œ</td>
            </tr>
            
            <tr class="top-data-row">
                <td contenteditable="false">jkgov1203</td>
                <td contenteditable="false">ë°œì†¡ ì™„ë£Œ</td>
                <td contenteditable="false">ìŠ¹ì¸ ì™„ë£Œ</td>
                <td contenteditable="false">NSACT2032897</td>
                <td contenteditable="false">NBS001001001</td>
            </tr>
            <tr class="top-data-row">
                <td contenteditable="false">sxcv4752</td>
                <td contenteditable="false">ê²€ìˆ˜ ëŒ€ê¸°</td>
                <td contenteditable="false">ë¯¸ìŠ¹ì¸</td>
                <td contenteditable="false">NSACT2032898</td>
                <td contenteditable="false">NBS001001002</td>
            </tr>
            <tr class="top-data-row">
                <td contenteditable="false">qwerty24689</td>
                <td contenteditable="false">ì§„í–‰ ì¤‘</td>
                <td contenteditable="false">ìŠ¹ì¸ ì™„ë£Œ</td>
                <td contenteditable="false">NSACT2032899</td>
                <td contenteditable="false">NBS001001003</td>
            </tr>
            <tr class="top-data-row">
                <td contenteditable="false">xsgf1575</td>
                <td contenteditable="false">ë°œì†¡ ì˜¤ë¥˜</td>
                <td contenteditable="false">ë¹„í™œì„±í™”</td>
                <td contenteditable="false">NSACT2032891</td>
                <td contenteditable="false">NBS001001004</td>
            </tr>
            
            <tr class="middle-notice-row">
                <td colspan="5" contenteditable="false">
                    1. ìœ„ ê³µë™êµ¬ë§¤ íšŒì›ë“¤ì´ í´ë¦¬ì–´ ë°ì´í„°ë¥¼ ì§€ì‹œì— ë”°ë¼ ì§„í–‰í•˜ì§€ ëª»í•˜ì—¬ ì‹¤íŒ¨ë¡œ ì¸í•´ íšŒì›ê°€ì… ë° ê³„ì • ë¹„í™œì„±í™”ë˜ì–´ ì¶œê¸ˆë¶ˆê°€ <br>
                    2. ìƒí˜¸í˜‘ë ¥ì˜ ë°œì „ëª©ì ì„ ì‹¤ì²œí•˜ê¸° ìœ„í•´ ê³µì‹ì ìœ¼ë¡œ 1~2íšŒ ì—°ì† í´ë¦¬ì–´ìˆ˜ì •ì„ íŠ¹ë³„íˆ ìŠ¹ì¸í•˜ì˜€ìœ¼ë©°, ìˆ˜ì •ì£¼ë¬¸ì€ ë§Œì¥ì¼ì¹˜ë¡œ í•©ì˜ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.<br>
                    3. ìˆ˜ì •ì£¼ë¬¸ì€ ê³„ì¢Œì™€ ê³„ì¢Œ ì´ìƒ ë°ì´í„° ë³µêµ¬ í›„ ì¶œê¸ˆ ì½”ë“œë¥¼ ë§¤ë‹ˆì € ê°±ì‹ ì„ ì™„ë£Œí•´ì•¼ ì¶œê¸ˆê°€ëŠ¥í•˜ë©° ë°ì´í„° ì™„ë£Œ ì´ì „ì—ëŠ” í˜„ê¸ˆ ì¶œê¸ˆì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤<br>
                    4.ì •ì‚°ì‹œìŠ¤í…œì—ì„œ ìŠ¹ì¸í•  ìˆ˜ ì—†ì–´ ì¶œê¸ˆí• ìˆ˜ ì—†ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ë°ì´í„° ì™„ë£Œ ì´ì „ì—ëŠ” í˜„ê¸ˆ ì¶œê¸ˆì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                    (ì˜ˆ: ë¶€í™œ í¬ê¸°í•œ ê³„ì •ì˜ ê²½ìš° í¬ì¸íŠ¸ì¶œê¸ˆ ë¶ˆê°€)
                </td>
            </tr>

            <tr class="bottom-data-header">
                <td class="w-20" contenteditable="false">ì£¼ë¬¸ìœ í˜•</td>
                <td class="w-20" contenteditable="false">ì£¼ë¬¸ìƒì„¸</td>
                <td contenteditable="false">íˆ¬ìê¸ˆì•¡ (ì›)</td>
                <td contenteditable="false">ì›ê¸ˆ+ìˆ˜ìµê¸ˆì•¡</td>
                <td contenteditable="false">ë³´ì¥ë¹„ìœ¨</td>
            </tr>

            <tr class="bottom-data-row">
                <td contenteditable="false">A</td>
                <td contenteditable="false">[2ì¢…íƒ1]</td>
                <td contenteditable="false" style="color: #FF0000;">1,500,000</td>
                <td contenteditable="false">1,650,000</td>
                <td contenteditable="false" style="color: #FF0000;">0%</td>
            </tr>
            <tr class="bottom-data-row">
                <td contenteditable="false">B</td>
                <td contenteditable="false">[2ì¢…íƒ1]</td>
                <td contenteditable="false">2,500,000</td>
                <td contenteditable="false">2,750,000</td>
                <td contenteditable="false">100%</td>
            </tr>
            <tr class="bottom-data-row">
                <td contenteditable="false">C</td>
                <td contenteditable="false">[2ì¢…íƒ1]</td>
                <td contenteditable="false">0</td>
                <td contenteditable="false">0</td>
                <td contenteditable="false" style="color: #FF0000;">0%</td>
            </tr>
            <tr class="bottom-data-row">
                <td contenteditable="false">D</td>
                <td contenteditable="false">[2ì¢…íƒ1]</td>
                <td contenteditable="false">0</td>
                <td contenteditable="false">0</td>
                <td contenteditable="false" style="color: #FF0000;">0%</td>
            </tr>

        </tbody>
    </table>
</div>

<div class="resizer-display" id="resizerDisplay"></div>

<script type="module">
    // Firebase ConfigëŠ” ë³´ì•ˆìƒ ì„œë²„ ì¸¡ì—ì„œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì›ì¹™ì´ì§€ë§Œ, 
    // ì—¬ê¸°ì„œëŠ” í´ë¼ì´ì–¸íŠ¸ ëª¨ë“ˆë¡œ ì§ì ‘ ì„¤ì •í•©ë‹ˆë‹¤. 
    // ì¤‘ìš”: Firestore Security Rule ì„¤ì • í•„ìˆ˜!
    const firebaseConfig = {
        apiKey: "AIzaSyBSkdUP_bU60GiLY6w9Uo7e8g_pkLllFPg",
        authDomain: "my-nonono3.firebaseapp.com",
        projectId: "my-nonono3",
        storageBucket: "my-nonono3.firebasestorage.app",
        messagingSenderId: "167865896202",
        appId: "1:167865896202:web:2567994bd29509f9d6fef3",
        measurementId: "G-T126HT4T7X"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const appId = firebaseConfig.appId;
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const TABLE_DOC_ID = 'main_table_state';
    let currentUserId = null;
    let isAuthReady = false;
    let initialLoadDone = false;

    // DOM refs
    const table = document.querySelector('.data-table');
    const colorPaletteContainer = document.getElementById('colorPaletteContainer');
    const applyFontSizeBtn = document.getElementById('applyFontSizeBtn');
    const fontSizeInput = document.getElementById('fontSizeInput');
    const selectionBox = document.getElementById('selectionBox');
    const leftMenu = document.getElementById('leftMenu');
    const menuIndicator = document.getElementById('menuIndicator');
    const topSubMenu = document.getElementById('topSubMenu');
    
    // Tool buttons
    const autoSaveToggleBtn = document.getElementById('autoSaveToggleBtn');
    const saveNowBtn = document.getElementById('saveNowBtn');
    const copyBtn = document.getElementById('copyBtn');
    const pasteBtn = document.getElementById('pasteBtn');
    const addRowBtn = document.getElementById('addRowBtn');
    const addColBtn = document.getElementById('addColBtn');
    const deleteRowBtn = document.getElementById('deleteRowBtn');
    const deleteColBtn = document.getElementById('deleteColBtn');
    const autoFitBtn = document.getElementById('autoFitBtn'); // New button ID
    const toggleAdminBtn = document.getElementById('toggleAdminBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadFullBtn = document.getElementById('downloadFullBtn');

    // New Feature DOM Refs: Table Structure Controls
    const newRowCountInput = document.getElementById('newRowCount');
    const newColCountInput = document.getElementById('newColCount');
    const defaultColWidthInput = document.getElementById('defaultColWidth');
    const defaultRowHeightInput = document.getElementById('defaultRowHeight');
    const applyTableStructureBtn = document.getElementById('applyTableStructureBtn');

    // constants
    const COLOR_PALETTE = [
        '#FFFFFF', '#000000', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#00FFFF', '#FF00FF',
        '#FFA500', '#800080', '#008000', '#808000', '#000080', '#800000', '#C0C0C0', '#808080',
        '#FF4500', '#ADFF2F', '#1E90FF', '#FFD700', '#20B2AA', '#E9967A', '#9400D3', '#FF69B4',
        '#A0522D', '#D2B48C', '#87CEEB', '#F08080', '#4682B4', '#DA70D6', '#B0C4DE', '#F4A460',
        '#5F9EA0', '#DDA0DD', '#7FFF00', '#6495ED', '#DC143C', '#FF8C00', '#9ACD32', '#40E0D0'
    ];

    // selection
    let isDragging = false;
    let startCell = null;
    let endCell = null;
    let selectedCells = new Set();
    let autoSave = false;
    let autoSaveDebounceMs = 800; // ë””ë°”ìš´ìŠ¤ íƒ€ì„
    let saveTimer = null;
    let adminMode = false; // ê¸°ë³¸ê°’ì€ ë¹„í™œì„±í™”(ì½ê¸° ì „ìš©)

    // helpers
    const debounce = (fn, ms) => {
        return (...args) => {
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(() => fn(...args), ms);
        };
    };

    const getTableDocRef = (userId) => doc(db, 'artifacts', appId, 'users', userId, 'table_data', TABLE_DOC_ID);

    const serializeTableState = () => {
        const cellStates = {};
        const rows = table.querySelectorAll('tr');
        rows.forEach((row, rIndex) => {
            row.querySelectorAll('td').forEach((cell, cIndex) => {
                const cellId = `r${rIndex}c${cIndex}`;
                cellStates[cellId] = {
                    text: cell.innerHTML,
                    color: cell.style.color || '',
                    bg: cell.style.backgroundColor || '',
                    fontSize: cell.style.fontSize || '',
                };
            });
        });

        const rowHeights = {};
        document.querySelectorAll('.height-apply-btn').forEach(button => {
            const target = button.dataset.target;
            let inputId = `${target.replace('-data', 'RowHeightInput')}`;
            if (target === 'middle-notice') inputId = 'middleNoticeRowHeightInput';
            const input = document.getElementById(inputId);
            if (input) rowHeights[target] = input.value;
        });

        return { cells: cellStates, rowHeights, timestamp: new Date() };
    };

    const saveTableStateImmediate = async () => {
        if (!currentUserId || !isAuthReady) return;
        try {
            await setDoc(getTableDocRef(currentUserId), serializeTableState(), { merge: true });
            console.log('Saved');
        } catch (e) {
            console.error('Save error', e);
        }
    };
    const saveTableStateDebounced = debounce(saveTableStateImmediate, autoSaveDebounceMs);

    // V2: í–‰ ë†’ì´ ì ìš© ë¡œì§ ê°œì„  (height, line-height ë¶„ë¦¬)
    const applyRowHeight = (target, value) => {
        const heightPx = `${value}px`;
        const lineHeight = `${parseInt(value) - 10}px`; // padding/border ê³ ë ¤
        
        const selectors = {
            'top-data': '.top-data-row, .top-data-header',
            'middle-notice': '.middle-notice-row',
            'bottom-data': '.bottom-data-row, .bottom-data-header'
        };

        document.querySelectorAll(selectors[target]).forEach(row => {
            row.style.height = heightPx;
            row.querySelectorAll('td').forEach(cell => {
                // TD ìì²´ì˜ heightë¥¼ 100%ë¡œ ì„¤ì •í•˜ì—¬ TR ë†’ì´ë¥¼ ë”°ë¥´ê²Œ í•˜ê³ , line-heightë¥¼ ì¡°ì •í•˜ì—¬ í…ìŠ¤íŠ¸ë¥¼ ì¤‘ì•™ì— ê°€ê¹ê²Œ ë°°ì¹˜
                cell.style.height = '100%';
                cell.style.lineHeight = lineHeight; 
            });
        });

        if (autoSave) saveTableStateDebounced();
    };


    const applyLoadedState = (data) => {
        if (!data) return;
        if (data.cells) {
            const rows = table.querySelectorAll('tr');
            rows.forEach((row, rIndex) => {
                row.querySelectorAll('td').forEach((cell, cIndex) => {
                    const cellId = `r${rIndex}c${cIndex}`;
                    const state = data.cells[cellId];
                    if (state) {
                        if (cell.innerHTML !== state.text) cell.innerHTML = state.text;
                        cell.style.color = state.color || '';
                        cell.style.backgroundColor = state.bg || '';
                        cell.style.fontSize = state.fontSize || '';
                    }
                });
            });
        }
        if (data.rowHeights) {
            for (const [key, value] of Object.entries(data.rowHeights)) {
                let inputId = `${key.replace('-data', 'RowHeightInput')}`;
                if (key === 'middle-notice') inputId = 'middleNoticeRowHeightInput';
                const input = document.getElementById(inputId);
                if (input) input.value = value;
                applyRowHeight(key, value); // ë¡œë“œ ì‹œ ë†’ì´ ì ìš©
            }
        }
        // Admin ëª¨ë“œê°€ êº¼ì ¸ìˆë‹¤ë©´ ì½ê¸° ì „ìš©ìœ¼ë¡œ ì„¤ì •
        if (!adminMode) {
            table.querySelectorAll('td').forEach(td => td.contentEditable = false);
        }
        clearSelection();
    };

    const loadTableState = (userId) => {
        const docRef = getTableDocRef(userId);
        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                applyLoadedState(docSnap.data());
            } else if (!initialLoadDone) {
                // ì´ˆê¸° ë¡œë“œ ì‹œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í˜„ì¬ ìƒíƒœë¥¼ ì €ì¥
                saveTableStateImmediate();
            }
            initialLoadDone = true;
        }, (error) => console.error('Listen error', error));
    };

    const initAuth = async () => {
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
            } else {
                try {
                    await signInAnonymously(auth);
                    currentUserId = auth.currentUser.uid;
                } catch (e) {
                    console.error('Auth failed', e);
                    return;
                }
            }
            if (currentUserId && !isAuthReady) {
                isAuthReady = true;
                loadTableState(currentUserId);
            }
        });
    };
    
    // Selection utilities
    const clearSelection = () => {
        selectedCells.forEach(td => td.classList.remove('selected'));
        selectedCells.clear();
        selectionBox.style.display = 'none';
    };

    const selectCellsInRect = (start, end) => {
        const startPos = getCellCoordinates(start);
        const endPos = getCellCoordinates(end);
        const r1 = Math.min(startPos.rowIndex, endPos.rowIndex);
        const r2 = Math.max(startPos.rowIndex, endPos.rowIndex);
        const c1 = Math.min(startPos.cellIndex, endPos.cellIndex);
        const c2 = Math.max(startPos.cellIndex, endPos.cellIndex);

        clearSelection();
        for (let r = r1; r <= r2; r++) {
            const row = table.rows[r];
            if (!row) continue;
            for (let c = c1; c <= c2; c++) {
                const cell = row.cells[c];
                // colspan/rowspan ì²˜ë¦¬ (ê°„ë‹¨í™”ë¥¼ ìœ„í•´ í˜„ì¬ëŠ” ìŠ¤í‚µ)
                if (!cell || cell.colSpan > 1 || cell.rowSpan > 1) continue; 
                cell.classList.add('selected');
                selectedCells.add(cell);
            }
        }
    };

    const updateSelectionBoxVisual = (start, end) => {
        const wrapRect = document.querySelector('.wrap').getBoundingClientRect();
        const sRect = start.getBoundingClientRect();
        const eRect = end.getBoundingClientRect();
        
        const tableRect = table.getBoundingClientRect();
        const wrapScrollLeft = document.querySelector('.wrap').scrollLeft;
        const wrapScrollTop = document.querySelector('.wrap').scrollTop;
        
        // í…Œì´ë¸” ì¢Œí‘œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
        const left = Math.min(sRect.left, eRect.left) - tableRect.left + wrapScrollLeft + 200; // 200px (Left Menu width) ë³´ì •
        const top = Math.min(sRect.top, eRect.top) - tableRect.top + wrapScrollTop + wrapRect.top - 20; // wrap top padding ë³´ì •
        const right = Math.max(sRect.right, eRect.right) - tableRect.left + wrapScrollLeft + 200;
        const bottom = Math.max(sRect.bottom, eRect.bottom) - tableRect.top + wrapScrollTop + wrapRect.top - 20;

        selectionBox.style.left = `${left}px`;
        selectionBox.style.top = `${top}px`;
        selectionBox.style.width = `${right - left}px`;
        selectionBox.style.height = `${bottom - top}px`;
        selectionBox.style.display = 'block';
    };

    const getCellCoordinates = (cell) => ({ rowIndex: cell.closest('tr').rowIndex, cellIndex: cell.cellIndex });

    // Mouse handlers
    const handleMouseDown = (e) => {
        // ì„¤ì • íŒ¨ë„ì´ë‚˜ ë©”ë‰´ë¥¼ í´ë¦­í•˜ë©´ ë¬´ì‹œ
        if (e.target.closest('.setting-panel') || e.target.closest('.left-menu')) return;
        const cell = e.target.closest('td');
        if (!cell) {
             clearSelection();
             return; // í…Œì´ë¸” ë°–ì´ë‚˜ ë¹ˆ ê³µê°„ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
        }

        // í…ìŠ¤íŠ¸ë¥¼ ë“œë˜ê·¸í•˜ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•´ preventDefault
        e.preventDefault(); 
        
        startCell = cell;
        endCell = cell;
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
    };

    const handleMouseMove = (e) => {
        if (!startCell) return;
        isDragging = true;
        
        // ë“œë˜ê·¸ ì¤‘ ìŠ¤í¬ë¡¤ ë°©ì§€
        e.preventDefault();

        const target = document.elementFromPoint(e.clientX, e.clientY);
        const cellUnder = target?.closest?.('td');
        if (cellUnder && cellUnder !== endCell) {
            endCell = cellUnder;
            selectCellsInRect(startCell, endCell);
            updateSelectionBoxVisual(startCell, endCell);
        }
    };

    const handleMouseUp = (e) => {
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
        
        if (!isDragging && startCell) {
            // í´ë¦­ë§Œ í•œ ê²½ìš° ë‹¨ì¼ ì„ íƒ (handleMouseDownì—ì„œ preventDefault í–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ ë‹¤ì‹œ ì„ íƒ)
            clearSelection();
            startCell.classList.add('selected');
            selectedCells.add(startCell);
            updateSelectionBoxVisual(startCell, startCell);
        }
        isDragging = false;
        startCell = null;
        endCell = null;
    };

    // Color palette render
    const renderColorPalette = () => {
        COLOR_PALETTE.forEach(col => {
            const d = document.createElement('div');
            d.className = 'color-swatch';
            d.style.backgroundColor = col;
            d.title = col;
            d.addEventListener('click', () => applyColorToSelection(col));
            colorPaletteContainer.appendChild(d);
        });
    };

    const applyColorToSelection = (color) => {
        const target = document.querySelector('input[name="colorTarget"]:checked').value;
        selectedCells.forEach(cell => {
            if (target === 'text') cell.style.color = color;
            else cell.style.backgroundColor = color;
        });
        if (autoSave) saveTableStateDebounced();
    };

    // Font size
    applyFontSizeBtn?.addEventListener('click', () => {
        const size = fontSizeInput.value + 'px';
        selectedCells.forEach(cell => cell.style.fontSize = size);
        if (autoSave) saveTableStateDebounced();
    });

    // Row height apply event
    document.querySelectorAll('.height-apply-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const target = btn.dataset.target;
            let inputId = `${target.replace('-data', 'RowHeightInput')}`;
            if (target === 'middle-notice') inputId = 'middleNoticeRowHeightInput';
            const input = document.getElementById(inputId);
            if (input) {
                applyRowHeight(target, input.value);
                if (autoSave) saveTableStateDebounced();
            }
        });
    });

    // ===========================================
    // New Feature: Dynamic Table Control Logic
    // ===========================================

    /**
     * í…Œì´ë¸” êµ¬ì¡°ë¥¼ ì™„ì „íˆ ìƒˆë¡œ ìƒì„±í•˜ê±°ë‚˜ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
     * @param {number} rowCount - ìƒì„±í•  ì´ í–‰ ê°œìˆ˜
     * @param {number} colCount - ìƒì„±í•  ì´ ì—´ ê°œìˆ˜
     * @param {number} defaultWidth - ê¸°ë³¸ ì—´ ë„ˆë¹„ (px)
     * @param {number} defaultHeight - ê¸°ë³¸ í–‰ ë†’ì´ (px)
     */
    const generateInitialTable = (rowCount, colCount, defaultWidth, defaultHeight) => {
        const tbody = table.querySelector('tbody');
        if (!tbody) return;

        // 1. ê¸°ì¡´ ë‚´ìš© ë¹„ìš°ê¸°
        tbody.innerHTML = '';
        
        // 2. í–‰ í´ë˜ìŠ¤ ë§¤í•‘ ì •ì˜ (ê¸°ì¡´ í…Œì´ë¸” êµ¬ì¡°ë¥¼ ìµœëŒ€í•œ ì¬í˜„)
        const ROW_CLASS_MAP = {
            0: 'top-notice-row',
            1: 'top-data-header',
            2: 'top-data-row', // 4ê°œì˜ top-data-row ì¤‘ ì²« ë²ˆì§¸
            3: 'top-data-row',
            4: 'top-data-row',
            5: 'top-data-row',
            6: 'middle-notice-row',
            7: 'bottom-data-header',
            8: 'bottom-data-row', // 4ê°œì˜ bottom-data-row ì¤‘ ì²« ë²ˆì§¸
            9: 'bottom-data-row',
            10: 'bottom-data-row',
            11: 'bottom-data-row',
            default: 'bottom-data-row'
        };

        for (let r = 0; r < rowCount; r++) {
            const tr = document.createElement('tr');
            // í–‰ ì¸ë±ìŠ¤ì— ë”°ë¼ í´ë˜ìŠ¤ ë¶€ì—¬. ì •ì˜ë˜ì§€ ì•Šì€ í–‰ì€ 'bottom-data-row'ë¡œ ì²˜ë¦¬
            tr.className = ROW_CLASS_MAP[r] || ROW_CLASS_MAP.default; 

            // ê³µì§€/í—¤ë” í–‰ì€ ì „ì²´ ë„ˆë¹„ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            const isFullWidthRow = tr.className.includes('notice-row') || tr.className.includes('header');
            
            if (isFullWidthRow && colCount > 1) {
                const td = document.createElement('td');
                // ê¸°ì¡´ ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ê¸°ë³¸ í…ìŠ¤íŠ¸ ì„¤ì •
                if (tr.className === 'top-notice-row') {
                    td.innerHTML = '<span class="top-notice-mark">DAMAGE!</span> ì£¼ì˜ì‚¬í•­';
                } else if (tr.className.includes('header')) {
                    td.innerHTML = `${tr.className.split('-')[0]} ë°ì´í„° í—¤ë”`;
                } else {
                     td.innerHTML = `${tr.className.split('-')[0]} ë‚´ìš© ì˜ì—­`;
                }
                
                td.contentEditable = tr.className.includes('notice-row') ? 'true' : 'false';
                td.setAttribute('colspan', colCount);
                td.style.height = `${defaultHeight}px`;
                td.style.lineHeight = `${defaultHeight - 10}px`;
                tr.appendChild(td);
            } else {
                // ì¼ë°˜ ë°ì´í„° í–‰ì€ ì»¬ëŸ¼ ê°œìˆ˜ë§Œí¼ ì…€ ìƒì„±
                for (let c = 0; c < colCount; c++) {
                    const td = document.createElement('td');
                    td.innerHTML = `${r + 1}-${c + 1}`; 
                    td.contentEditable = adminMode ? 'true' : 'false';

                    // ë„ˆë¹„ì™€ ë†’ì´ ì„¤ì •
                    td.style.width = `${defaultWidth}px`;
                    td.style.minWidth = `${defaultWidth}px`; 
                    td.style.height = `${defaultHeight}px`;
                    td.style.lineHeight = `${defaultHeight - 10}px`; // í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ ë³´ì •

                    tr.appendChild(td);
                }
            }
            
            tbody.appendChild(tr);
        }
        
        // ìƒˆë¡œ ìƒì„±ëœ í…Œì´ë¸”ì— ê¸°ì¡´ í–‰ ë†’ì´ ì»¨íŠ¸ë¡¤ ê°’ì„ ë‹¤ì‹œ ì ìš©
        document.querySelectorAll('.height-apply-btn').forEach(btn => {
            const target = btn.dataset.target;
            let inputId = `${target.replace('-data', 'RowHeightInput')}`;
            if (target === 'middle-notice') inputId = 'middleNoticeRowHeightInput';
            const input = document.getElementById(inputId);
            if (input) applyRowHeight(target, input.value);
        });

        if (autoSave) saveTableStateDebounced();
    };

    // í…Œì´ë¸” êµ¬ì¡° ë³€ê²½ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    applyTableStructureBtn?.addEventListener('click', () => {
        const rowCount = parseInt(newRowCountInput.value, 10) || 5;
        const colCount = parseInt(newColCountInput.value, 10) || 5;
        const colWidth = parseInt(defaultColWidthInput.value, 10) || 120;
        const rowHeight = parseInt(defaultRowHeightInput.value, 10) || 25;
        
        generateInitialTable(rowCount, colCount, colWidth, rowHeight);
    });

    // ì—´ ë„ˆë¹„ ìë™ ë§ì¶¤ ê¸°ëŠ¥ (ë²„íŠ¼ì€ ìˆìœ¼ë‚˜ ë³µì¡í•˜ì—¬ í˜„ì¬ëŠ” ê²½ê³ ë§Œ í‘œì‹œ)
    const autoFitColumns = () => {
        alert("ì—´ ë„ˆë¹„ ìë™ ë§ì¶¤ ê¸°ëŠ¥ì€ ë¡œì§ì´ ë³µì¡í•˜ì—¬ í˜„ì¬ëŠ” ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë„ˆë¹„ë¥¼ ì¡°ì •í•´ ì£¼ì„¸ìš”.");
    };

    autoFitBtn?.addEventListener('click', autoFitColumns);
    
    // ===========================================
    // Initialization
    // ===========================================

    const init = () => {
        renderColorPalette();
        document.addEventListener('mousedown', handleMouseDown);
        // ... (other event listeners: copy/paste/admin/etc. logic should be here) ...

        // ì´ˆê¸° í…Œì´ë¸” í¬ê¸° ì •ë³´ ì„¤ì •
        const initialRowCount = table.querySelectorAll('tr').length;
        // top-notice-rowê°€ colspanì„ ì‚¬ìš©í•˜ë¯€ë¡œ, ë‘ ë²ˆì§¸ í–‰ì˜ ì…€ ê°œìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì»¬ëŸ¼ ìˆ˜ë¥¼ íŒŒì•…
        const initialColCount = table.rows.length > 1 ? table.rows[1].cells.length : 5; 
        
        // ì…ë ¥ í•„ë“œì˜ ì´ˆê¸°ê°’ ì„¤ì •
        newRowCountInput.value = initialRowCount;
        newColCountInput.value = initialColCount;
        // ê¸°ë³¸ ë„ˆë¹„/ë†’ì´ëŠ” CSSì™€ ê¸°ì¡´ ê°’ì— ë”°ë¼ 120/25ë¡œ ì„¤ì • (ì‚¬ìš©ìê°€ ì¡°ì ˆ ê°€ëŠ¥)
        defaultColWidthInput.value = 120;
        defaultRowHeightInput.value = 25;

        // í…Œì´ë¸” ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë“œ ì‹œì‘
        initAuth();
    };

    init();
</script>
</body>
</html>
